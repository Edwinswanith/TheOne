{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://gtmgraph.ai/schemas/agent_output.schema.json",
  "title": "AgentOutput",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "agent",
    "run_id",
    "produced_at",
    "patches",
    "proposals",
    "facts",
    "assumptions",
    "risks",
    "required_inputs",
    "node_updates"
  ],
  "properties": {
    "agent": { "type": "string" },
    "run_id": { "type": "string" },
    "produced_at": { "type": "string", "format": "date-time" },
    "patches": {
      "type": "array",
      "items": { "$ref": "#/$defs/StatePatch" }
    },
    "proposals": {
      "type": "array",
      "items": { "$ref": "#/$defs/DecisionProposal" }
    },
    "facts": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["claim", "supporting_sources", "confidence"],
        "properties": {
          "claim": { "type": "string" },
          "supporting_sources": { "type": "array", "items": { "type": "string" } },
          "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
        }
      }
    },
    "assumptions": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["statement", "why_it_matters", "how_to_validate", "confidence"],
        "properties": {
          "statement": { "type": "string" },
          "why_it_matters": { "type": "string" },
          "how_to_validate": { "type": "string" },
          "confidence": { "type": "number", "minimum": 0, "maximum": 1 }
        }
      }
    },
    "risks": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["risk", "severity", "mitigation"],
        "properties": {
          "risk": { "type": "string" },
          "severity": { "type": "string", "enum": ["critical", "high", "medium", "low"] },
          "mitigation": { "type": "string" }
        }
      }
    },
    "required_inputs": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["field", "question", "blocking"],
        "properties": {
          "field": { "type": "string" },
          "question": { "type": "string" },
          "blocking": { "type": "boolean" }
        }
      }
    },
    "node_updates": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["node_id", "action", "payload"],
        "properties": {
          "node_id": { "type": "string" },
          "action": { "type": "string", "enum": ["create", "update", "finalize"] },
          "payload": { "type": "object" }
        }
      }
    }
  },
  "$defs": {
    "Meta": {
      "type": "object",
      "additionalProperties": false,
      "required": ["source_type", "confidence", "sources"],
      "properties": {
        "source_type": { "type": "string", "enum": ["evidence", "inference", "assumption"] },
        "confidence": { "type": "number", "minimum": 0, "maximum": 1 },
        "sources": { "type": "array", "items": { "type": "string" } }
      }
    },
    "StatePatch": {
      "type": "object",
      "additionalProperties": false,
      "required": ["op", "path", "value", "meta"],
      "properties": {
        "op": { "type": "string", "enum": ["add", "replace", "remove"] },
        "path": { "type": "string" },
        "value": {},
        "meta": { "$ref": "#/$defs/Meta" }
      }
    },
    "DecisionProposal": {
      "type": "object",
      "additionalProperties": false,
      "required": ["decision_key", "options", "recommended_option_id", "rationale", "meta"],
      "properties": {
        "decision_key": {
          "type": "string",
          "enum": ["icp", "positioning", "pricing", "channels", "sales_motion"]
        },
        "options": {
          "type": "array",
          "minItems": 1,
          "maxItems": 3,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["id", "label", "details", "pros", "cons", "risks"],
            "properties": {
              "id": { "type": "string" },
              "label": { "type": "string" },
              "details": { "type": "object" },
              "pros": { "type": "array", "items": { "type": "string" } },
              "cons": { "type": "array", "items": { "type": "string" } },
              "risks": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "recommended_option_id": { "type": "string" },
        "rationale": { "type": "string" },
        "meta": { "$ref": "#/$defs/Meta" }
      }
    }
  }
}
